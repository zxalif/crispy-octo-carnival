# Docker Compose for Rixly - PRODUCTION (Host Network Mode)
# Uses native PostgreSQL and Redis (not Docker containers)
# Port: 8000
# 
# IMPORTANT: This version uses host network mode
# - Container shares host's network stack
# - localhost works directly (no host.docker.internal needed)
# - No port mapping needed
# - Less network isolation (container has full host network access)
#
# PROS:
# - Simpler configuration (localhost works)
# - Better performance (no NAT)
# - No extra_hosts needed
#
# CONS:
# - No network isolation (security consideration)
# - Can't run multiple containers on same port
# - Containers can't use service names to communicate

services:
  # ===== Rixly API Service =====
  api:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: rixly-api
    network_mode: host  # Use host network - localhost works!
    environment:
      # API Configuration
      - API_KEY=${API_KEY}
      
      # Reddit API
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET}
      - REDDIT_USER_AGENT=${REDDIT_USER_AGENT:-clienthunt/1.0}
      
      # LLM API Keys
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Database (Native PostgreSQL on host)
      # localhost works because we're using host network mode!
      - DATABASE_URL=${DATABASE_URL}
      # If DATABASE_URL not set, build from parts (localhost works!)
      - DATABASE_HOST=${DATABASE_HOST:-localhost}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_NAME=${DATABASE_NAME:-rixly}
      - DATABASE_USER=${DATABASE_USER:-rixly}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      
      # Application Settings
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/app.log
      - ENVIRONMENT=production
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-false}
      - SCHEDULER_CHECK_INTERVAL=${SCHEDULER_CHECK_INTERVAL:-60}
      - JOB_COOLDOWN_MINUTES=${JOB_COOLDOWN_MINUTES:-5}
      
      # Reddit Rate Limiting
      - REDDIT_RATE_LIMIT_DELAY=${REDDIT_RATE_LIMIT_DELAY:-1.0}
      - REDDIT_MAX_REQUESTS_PER_MINUTE=${REDDIT_MAX_REQUESTS_PER_MINUTE:-60}
      - REDDIT_CONNECTION_TIMEOUT=${REDDIT_CONNECTION_TIMEOUT:-30.0}
      - REDDIT_RETRY_ATTEMPTS=${REDDIT_RETRY_ATTEMPTS:-3}
      - REDDIT_RETRY_DELAY=${REDDIT_RETRY_DELAY:-2.0}
      - REDDIT_MAX_POSTS_PER_SEARCH=${REDDIT_MAX_POSTS_PER_SEARCH:-1000}
      - REDDIT_MAX_COMMENTS_PER_POST=${REDDIT_MAX_COMMENTS_PER_POST:-500}
      
      # Redis Configuration (for rate limiting)
      # localhost works because we're using host network mode!
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - rixly_logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # ===== Scheduler Service =====
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: rixly-scheduler
    network_mode: host  # Use host network - localhost works!
    environment:
      # Database (localhost works!)
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_HOST=${DATABASE_HOST:-localhost}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_NAME=${DATABASE_NAME:-rixly}
      - DATABASE_USER=${DATABASE_USER:-rixly}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      
      # Reddit API
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET}
      - REDDIT_USER_AGENT=${REDDIT_USER_AGENT:-clienthunt/1.0}
      
      # LLM API Keys
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Application Settings
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/app.log
      - ENVIRONMENT=production
      - SCHEDULER_ENABLED=true
      - SCHEDULER_CHECK_INTERVAL=${SCHEDULER_CHECK_INTERVAL:-60}
      - JOB_COOLDOWN_MINUTES=${JOB_COOLDOWN_MINUTES:-5}
      
      # Reddit Rate Limiting
      - REDDIT_RATE_LIMIT_DELAY=${REDDIT_RATE_LIMIT_DELAY:-1.0}
      - REDDIT_MAX_REQUESTS_PER_MINUTE=${REDDIT_MAX_REQUESTS_PER_MINUTE:-60}
      - REDDIT_CONNECTION_TIMEOUT=${REDDIT_CONNECTION_TIMEOUT:-30.0}
      - REDDIT_RETRY_ATTEMPTS=${REDDIT_RETRY_ATTEMPTS:-3}
      - REDDIT_RETRY_DELAY=${REDDIT_RETRY_DELAY:-2.0}
      - REDDIT_MAX_POSTS_PER_SEARCH=${REDDIT_MAX_POSTS_PER_SEARCH:-1000}
      - REDDIT_MAX_COMMENTS_PER_POST=${REDDIT_MAX_COMMENTS_PER_POST:-500}
    volumes:
      - rixly_logs:/app/logs
    restart: unless-stopped
    command: python scripts/run_scheduler.py
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

# ===== Volumes =====
volumes:
  rixly_logs:
    driver: local
    name: rixly-logs

# NOTE: No networks section needed with host network mode

